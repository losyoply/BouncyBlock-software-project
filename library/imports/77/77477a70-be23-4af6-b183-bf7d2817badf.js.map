{"version":3,"sources":["assets\\scripts\\bird_map_init.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["const {ccclass, property} = cc._decorator;\r\n\r\n@ccclass\r\nexport class BirdBase extends cc.Component {\r\n\r\n    private base: number = 6;\r\n    private strip: number = 1;\r\n\r\n    @property(cc.Prefab)\r\n    coin: cc.Prefab = null;\r\n\r\n    onLoad () {\r\n        cc.director.getCollisionManager().enabled = true;\r\n        cc.director.getCollisionManager().enabledDrawBoundingBox = true;\r\n        cc.director.getPhysicsManager().enabled = true;\r\n        // cc.director.getPhysicsManager().debugDrawFlags = 1;\r\n        cc.director.getPhysicsManager().gravity = cc.v2(0, -600);\r\n    }\r\n    onDestroy () {\r\n        cc.director.getCollisionManager().enabled = false;\r\n        cc.director.getCollisionManager().enabledDebugDraw = false;\r\n        cc.director.getCollisionManager().enabledDrawBoundingBox = false;\r\n    }\r\n\r\n    start(){\r\n        this.node.anchorX = 0;\r\n        this.node.anchorY = 0;\r\n        var map = this.node.getComponent(cc.TiledMap);\r\n        this.strip = cc.find('Canvas/root').getComponent('root').color_strip;         //每次更新的section 色票都要一樣\r\n        this.base = 1 + 6*this.strip;\r\n\r\n        //console.log(\"base color gid: \" + this.base);\r\n\r\n        var body = this.node.addComponent(cc.RigidBody);\r\n        body.type = cc.RigidBodyType.Static;\r\n        body.fixedRotation = true;\r\n        var collider = this.node.addComponent(cc.PhysicsBoxCollider);\r\n        collider.offset = cc.v2(960, 240);\r\n        collider.size = cc.size(5, 1000);\r\n        collider.sensor = true;\r\n        collider.tag = 1000;        // init next map on contact\r\n        collider.apply();\r\n\r\n        var sz = map.getTileSize();\r\n        console.log(sz);\r\n\r\n        var floor = map.getLayer(\"ground\");\r\n        var layerSz = floor.getLayerSize();\r\n        if(this.node.name == \"bird0\"){\r\n            for(var i = 0; i < layerSz.width; i++){\r\n                for(var j = 0; j < layerSz.height; j++){\r\n                    var FloorTile = floor.getTiledTileAt(i, j, true);\r\n                    if(FloorTile.gid != 0){\r\n                        // console.log(\"draw ground box for tile (\" + i + \", \" + j + \")\");\r\n                        FloorTile.node.group = \"ground\";\r\n                        // console.log(\"created tile with \" + FloorTile.node.group)\r\n                        FloorTile.gid = this.base;\r\n                        var body = FloorTile.node.addComponent(cc.RigidBody);\r\n                        body.type = cc.RigidBodyType.Static;\r\n                        body.fixedRotation = true;\r\n                        var collider = FloorTile.node.addComponent(cc.PhysicsBoxCollider);\r\n                        collider.offset = cc.v2(sz.width/2, sz.height/2);\r\n                        collider.size = sz;\r\n                        collider.apply();\r\n                    }\r\n                }\r\n            }\r\n        }else{\r\n            for(var i = 0; i < layerSz.width; i++){\r\n                for(var j = 0; j < layerSz.height; j++){\r\n                    var FloorTile = floor.getTiledTileAt(i, j, true);\r\n                    FloorTile.gid = this.base;\r\n                }\r\n            }\r\n\r\n            console.log(\"tile init complete, digging path(s)\")\r\n            var pathrange = [2, 17];        // path should be range between j = 2 and j = 17\r\n\r\n            for(var i = 0; i < layerSz.width; i++){\r\n                // set gid to 0 for path\r\n                var range = Math.floor(Math.random() * 3);\r\n                var up_range_min = Math.max(2, pathrange[0]-range);\r\n                var down_range_min = Math.min(17, pathrange[1]+range);\r\n                range = Math.floor(Math.random() * 3);\r\n                var up_range_max = Math.min(pathrange[1]-range, pathrange[0]+range);\r\n                var down_range_max = Math.max(pathrange[0]+range, pathrange[1]-range);\r\n                \r\n\r\n                var down_bound = Math.floor(Math.random() * (down_range_max - down_range_min)) + down_range_min;\r\n                var up_bound =  Math.floor(Math.random() * (up_range_max - up_range_min)) + up_range_min;\r\n                if(down_bound - up_bound < 4){\r\n                    down_bound++;\r\n                    up_bound--;\r\n                }\r\n                \r\n                console.log(up_bound, down_bound);\r\n                for(var k = up_bound; k < down_bound; k++) floor.getTiledTileAt(i, k, true).gid = 0;\r\n                pathrange[0] = up_bound;\r\n                pathrange[1] = down_bound;\r\n            }\r\n\r\n            var section_count = cc.find('Canvas/root/bird_player').getComponent('bird_player').section_count;\r\n            for(var i = 0; i < layerSz.width; i++){\r\n                for(var j = 0; j < layerSz.height; j++){\r\n                    var FloorTile = floor.getTiledTileAt(i, j, true);\r\n                    if(FloorTile.gid != 0){\r\n                        FloorTile.node.group = \"ground\";\r\n                        // console.log(\"created tile with \" + FloorTile.node.group)\r\n                        FloorTile.gid = this.base;\r\n                        var body = FloorTile.node.addComponent(cc.RigidBody);\r\n                        body.type = cc.RigidBodyType.Static;\r\n                        body.fixedRotation = true;\r\n                        var collider = FloorTile.node.addComponent(cc.PhysicsBoxCollider);\r\n                        collider.offset = cc.v2(sz.width/2, sz.height/2);\r\n                        collider.size = sz;\r\n                        collider.apply();\r\n                    }\r\n                }\r\n                var max_allowed = 5;\r\n                for(var j = 3; j < layerSz.height-3; j++){\r\n                    var FloorTile = floor.getTiledTileAt(i, j, true);\r\n                    if(FloorTile.gid == 0){\r\n                        if(floor.getTiledTileAt(i, j-3, true).gid != 0) continue;\r\n                        var nocoin = Math.floor(Math.random() * 8);\r\n                        if(!nocoin){\r\n                            //init coin\r\n                            max_allowed--;\r\n                            var c = cc.instantiate(this.coin);\r\n                            c.x = section_count * 1920 + FloorTile.node.x;\r\n                            c.y = FloorTile.node.y;\r\n                            console.log(\"coin at \" + c.x, c.y);\r\n                            //c.active = true;\r\n                            cc.find(\"Canvas/root/mapworld/coin_bubble\").addChild(c);\r\n                            if(!max_allowed) break;\r\n                        }else{\r\n                            if(floor.getTiledTileAt(i, j+3, true).gid != 0) break;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n"]}